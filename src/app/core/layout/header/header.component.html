<header class="bg-white/70 dark:bg-slate-950/70 backdrop-blur-2xl border-b border-slate-200/50 dark:border-slate-800/50 z-50 fixed top-0 w-full h-20 transition-all duration-300">
  <div class="h-full px-6 lg:px-10 flex items-center justify-between">
    
    <!-- LEFT: Logo & Modules Menu -->
    <div class="flex items-center gap-6">
      <div (click)="goLauncher()" class="flex items-center gap-4 cursor-pointer group">
        <ng-container *ngIf="session.currentCompany() || session.currentTenant(); else systemBranding">
          <ng-container *ngIf="session.currentCompany()?.logo_url || session.currentTenant()?.logo_url; else defaultLogo">
            <img [src]="session.currentCompany()?.logo_url || session.currentTenant()?.logo_url" alt="Company Logo" class="w-11 h-11 rounded-2xl object-cover flex-shrink-0 bg-white shadow-lg group-hover:shadow-indigo-500/10 transition-all border border-slate-100">
          </ng-container>
          <ng-template #defaultLogo>
            <div class="w-11 h-11 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white text-xl font-black group-hover:scale-105 transition-transform flex-shrink-0 shadow-lg">
              {{ getCompanyInitial() }}
            </div>
          </ng-template>
          <div class="flex flex-col">
            <span class="text-[9px] text-slate-400 dark:text-slate-500 font-black uppercase tracking-[0.3em] leading-none mb-1 opacity-70 group-hover:opacity-100 transition-opacity whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]">Contexto Activo</span>
            <span class="font-black text-lg tracking-tight text-slate-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 transition truncate max-w-[120px] sm:max-w-xs leading-none">
                {{ session.currentCompany()?.name || session.currentTenant()?.name }}
            </span>
          </div>
        </ng-container>

        <ng-template #systemBranding>
          <div class="flex items-center gap-3">
             <div class="p-2 bg-primary-600 rounded-xl shadow-lg shadow-primary-500/20">
                <span class="text-xl font-black tracking-tighter text-white uppercase italic">SIAC</span>
             </div>
             <span class="text-[9px] font-black text-slate-400 dark:text-slate-500 tracking-[0.4em] uppercase">Digital Core</span>
          </div>
        </ng-template>
      </div>

      <div class="h-8 w-px bg-slate-200 dark:bg-slate-800 mx-4 hidden lg:block"></div>

      <!-- Modules Dropdown Trigger -->
      <div class="relative" #menuContainer id="header-modules-menu">
        <button 
          (click)="toggleMenu()"
          class="flex items-center gap-3 px-5 py-2.5 rounded-2xl text-[11px] font-black uppercase tracking-widest text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-all focus:outline-none border border-transparent hover:border-slate-200 dark:hover:border-slate-800"
          [class.bg-slate-100]="isMenuOpen()"
          [class.dark:bg-slate-800/80]="isMenuOpen()"
          [class.border-slate-200]="isMenuOpen()">
          <ng-icon [name]="ICONS.menu" class="w-5 h-5 opacity-70"></ng-icon>
          <span class="hidden md:inline">Ecosistemas</span>
          <ng-icon 
            [name]="ICONS.dropdown" 
            class="w-3.5 h-3.5 opacity-50 transition-transform duration-300"
            [class.rotate-180]="isMenuOpen()">
          </ng-icon>
        </button>

        <!-- Dropdown Menu (Premium & Large) -->
        <div *ngIf="isMenuOpen()" 
             class="fixed inset-x-0 top-20 bottom-0 bg-white dark:bg-slate-900 z-[60] overflow-y-auto lg:absolute lg:inset-auto lg:top-[calc(100%+8px)] lg:left-0 lg:w-[480px] lg:rounded-[2.5rem] lg:shadow-2xl lg:ring-1 lg:ring-black lg:ring-opacity-5 lg:py-6 lg:overflow-hidden animate-in fade-in slide-in-from-top-4 duration-300 border border-slate-100 dark:border-slate-800">
          
          <div class="lg:max-h-[calc(100vh-200px)] lg:overflow-y-auto w-full custom-scrollbar">
            <div class="px-8 pb-4 mb-4 border-b border-slate-50 dark:border-slate-800">
                <h3 class="text-[10px] font-black text-primary-500 uppercase tracking-[0.3em]">Centro de Navegaci贸n</h3>
                <p class="text-[9px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-widest mt-0.5">M贸dulos habilitados por suscripci贸n</p>
            </div>

            <ng-container *ngFor="let group of groupedModules()">
              <div class="px-8 py-3 bg-slate-50/50 dark:bg-slate-800/30 border-y border-slate-50 dark:border-slate-800/30 first:border-t-0 sticky top-0 z-10 backdrop-blur-lg">
                <span class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em]">{{ group.category }}</span>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 p-4 px-6">
                <a *ngFor="let module of group.modules"
                   [routerLink]="module.route_path"
                   (click)="closeMenu()"
                   class="group flex items-center gap-4 px-4 py-4 rounded-3xl hover:bg-white dark:hover:bg-slate-800 hover:shadow-xl hover:shadow-indigo-500/5 transition-all cursor-pointer border border-transparent hover:border-slate-100 dark:hover:border-slate-700">
                  <div 
                    class="flex-shrink-0 w-11 h-11 rounded-2xl flex items-center justify-center transition-all group-hover:scale-110 group-hover:rotate-3 shadow-inner"
                    [style.backgroundColor]="(module.color || '#6366f1') + '15'"
                    [style.color]="module.color || '#6366f1'">
                    <ng-icon [name]="resolveIcon(module.icon)" class="w-6 h-6"></ng-icon>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-black text-slate-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors uppercase italic">{{ module.name }}</p>
                    <p class="text-[9px] font-bold text-slate-400 dark:text-slate-500 truncate mt-0.5">{{ module.description }}</p>
                  </div>
                </a>
              </div>
            </ng-container>

            <div *ngIf="groupedModules().length === 0" class="px-8 py-12 text-center">
              <ng-icon [name]="ICONS.empty" class="w-10 h-10 mx-auto mb-3 text-slate-200 dark:text-slate-700"></ng-icon>
              <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-relaxed">No se encontraron m贸dulos instalados para esta entidad.</p>
            </div>
          </div>

          <div class="p-6 bg-slate-50/50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-700">
            <a routerLink="/launcher" (click)="closeMenu()" class="flex items-center justify-center w-full py-4 text-[10px] font-black uppercase tracking-[0.3em] text-white bg-primary-600 hover:bg-primary-700 rounded-2xl transition-all shadow-lg shadow-primary-500/20">
              <ng-icon name="heroQueueListSolid" class="w-4 h-4 mr-2"></ng-icon>
              Dashboard Principal
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: User Profile & Context -->
    <div class="flex items-center gap-3">
      <!-- SEARCH TRIGGER -->
      <button (click)="openSearch()" class="p-3 text-slate-400 hover:text-primary-500 dark:text-slate-500 dark:hover:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/10 rounded-2xl transition-all border border-transparent hover:border-primary-100 dark:hover:border-primary-500/10">
        <ng-icon name="heroMagnifyingGlassSolid" class="h-5 w-5"></ng-icon>
      </button>

      <!-- Dark Mode Toggle -->
      <button (click)="themeService.toggleDarkMode()" class="p-3 text-slate-400 hover:text-amber-500 dark:text-slate-500 dark:hover:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/10 rounded-2xl transition-all border border-transparent hover:border-amber-100 dark:hover:border-amber-500/10 group">
        <ng-icon [name]="themeService.isDark() ? 'heroSunSolid' : 'heroMoonSolid'" class="h-5 w-5"></ng-icon>
      </button>

      <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2 hidden md:block"></div>

      <!-- User Avatar -->
      <button (click)="goSettings()" class="flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-800 p-2 pr-6 rounded-full transition-all group border border-transparent hover:border-slate-100 dark:hover:border-slate-800 focus:outline-none">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-black shadow-lg group-hover:scale-105 transition-transform">
          {{ getUserInitials() }}
        </div>
        <div class="hidden sm:flex flex-col items-start">
            <span class="text-[9px] font-black text-primary-500 uppercase tracking-widest leading-none mb-1">Operador</span>
            <span class="text-[11px] font-black text-slate-900 dark:text-white uppercase italic leading-none">{{ session.currentUserRole() || 'Mi Perfil' }}</span>
        </div>
      </button>
    </div>
  </div>
</header>
<!-- Spacer to prevent content overlap -->
<div class="h-20"></div>

<!-- GLOBAL SEARCH MODAL -->
<ng-container *ngIf="isSearchOpen()">
    <app-global-search-modal (closed)="isSearchOpen.set(false)"></app-global-search-modal>
</ng-container>
